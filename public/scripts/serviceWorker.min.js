// serviceWorker.min.js

self.addEventListener('install', event => {
  console.log('Service Worker installing.');
});

self.addEventListener('activate', event => {
  console.log('Service Worker activating.');
});

self.addEventListener('fetch', event => {
  console.log(`Fetching: ${event.request.url}`);
  event.respondWith(
    caches.match(event.request).then(response => response || fetch(event.request))
  );
});

self.addEventListener('sync', event => {
  if (event.tag === 'send-notification') {
    event.waitUntil(sendNotification());
  }
});

async function sendNotification(clientId = null) {
  const clients = await self.clients.matchAll({ type: 'window', includeUncontrolled: true });

  // 特定のクライアントにのみ通知を送信
  clients.forEach(client => {
    if (!clientId || client.id === clientId) {
      client.postMessage({ action: 'notify' });
    }
  });

  self.registration.showNotification("今すぐ歩かないと！！", {
    body: "散歩の時間です",
    icon: "https://www.kaigo-antenna.jp/uploads/illustration/main_image/789/202107_009_s.jpg",
    tag: "myTag",
    vibrate: [100, 100, 100],
  });
}

self.addEventListener('message', event => {
  if (event.data && event.data.action === 'getClientId') {
    event.source.postMessage({ clientId: event.source.id });
  } else if (event.data && event.data.action === 'send-notification') {
    sendNotification(event.data.clientId);
  }
});
